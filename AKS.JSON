{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {},
  "variables": {},
  "resources": [
    {
      "type": "Microsoft.ContainerService/managedClusters",
      "apiVersion": "2021-10-01",
      "name": "aks2",
      "location": "centralus",
      "sku": {
        "name": "Basic",
        "tier": "Free"
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "kubernetesVersion": "1.21.7",
        "dnsPrefix": "aks2-dns",
        "agentPoolProfiles": [
          {
            "name": "agentpool",
            "count": 1,
            "vmSize": "Standard_B4ms",
            "osDiskSizeGB": 128,
            "osDiskType": "Managed",
            "kubeletDiskType": "OS",
            "vnetSubnetID": "/subscriptions/62cba975-9596-4b65-a542-cf23fc36d81f/resourceGroups/iot/providers/Microsoft.Network/virtualNetworks/iot-vnet/subnets/default",
            "maxPods": 110,
            "type": "VirtualMachineScaleSets",
            "enableAutoScaling": false,
            "powerState": {
              "code": "Running"
            },
            "orchestratorVersion": "1.21.7",
            "enableNodePublicIP": false,
            "mode": "System",
            "osType": "Linux",
            "osSKU": "Ubuntu",
            "enableFIPS": false
          }
        ],
        "windowsProfile": {
          "adminUsername": "azureuser",
          "enableCSIProxy": true
        },
        "servicePrincipalProfile": {
          "clientId": "msi"
        },
        "addonProfiles": {
          "azureKeyvaultSecretsProvider": {
            "enabled": false
          },
          "azurepolicy": {
            "enabled": false
          },
          "httpApplicationRouting": {
            "enabled": false
          },
          "omsAgent": {
            "enabled": true,
            "config": {
              "logAnalyticsWorkspaceResourceID": "/subscriptions/62cba975-9596-4b65-a542-cf23fc36d81f/resourceGroups/DefaultResourceGroup-PAR/providers/Microsoft.OperationalInsights/workspaces/DefaultWorkspace-62cba975-9596-4b65-a542-cf23fc36d81f-PAR"
            }
          }
        },
        "nodeResourceGroup": "MC_iot_aks2_centralus",
        "enableRBAC": true,
        "networkProfile": {
          "networkPlugin": "azure",
          "loadBalancerSku": "Standard",
          "loadBalancerProfile": {
            "managedOutboundIPs": {
              "count": 1
            },
            "effectiveOutboundIPs": [
              {
                "id": "/subscriptions/62cba975-9596-4b65-a542-cf23fc36d81f/resourceGroups/MC_iot_aks2_centralus/providers/Microsoft.Network/publicIPAddresses/7726d092-715c-497b-b62b-4e180317f50b"
              }
            ]
          },
          "serviceCidr": "10.0.0.0/16",
          "dnsServiceIP": "10.0.0.10",
          "dockerBridgeCidr": "172.17.0.1/16",
          "outboundType": "loadBalancer"
        },
        "apiServerAccessProfile": {
          "enablePrivateCluster": false
        },
        "identityProfile": {
          "kubeletidentity": {
            "resourceId": "/subscriptions/62cba975-9596-4b65-a542-cf23fc36d81f/resourcegroups/MC_iot_aks2_centralus/providers/Microsoft.ManagedIdentity/userAssignedIdentities/aks2-agentpool",
            "clientId": "e5f5ef1d-2b83-4d56-9857-79f37af601f8",
            "objectId": "537519d3-d76d-4f42-8f70-b793329b7170"
          }
        }
      }
    },
    {
      "type": "Microsoft.ContainerService/managedClusters/agentPools",
      "apiVersion": "2021-10-01",
      "name": "aks2/agentpool",
      "dependsOn": [
        "[resourceId('Microsoft.ContainerService/managedClusters', 'aks2')]"
      ],
      "properties": {
        "count": 1,
        "vmSize": "Standard_B4ms",
        "osDiskSizeGB": 128,
        "osDiskType": "Managed",
        "kubeletDiskType": "OS",
        "vnetSubnetID": "/subscriptions/62cba975-9596-4b65-a542-cf23fc36d81f/resourceGroups/iot/providers/Microsoft.Network/virtualNetworks/iot-vnet/subnets/default",
        "maxPods": 110,
        "type": "VirtualMachineScaleSets",
        "enableAutoScaling": false,
        "powerState": {
          "code": "Running"
        },
        "orchestratorVersion": "1.21.7",
        "enableNodePublicIP": false,
        "mode": "System",
        "osType": "Linux",
        "osSKU": "Ubuntu",
        "enableFIPS": false
      }
    }
  ]
}